#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('onlineService:server');
var http = require('http');
var util = require('util');// 输出对象 util.inspect(s)

/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * Create HTTP server.
*/

var server = http.createServer(app);

/**
 * Start IO server.
 */

var io = require('socket.io').listen(server);
var serviceUserArr = new Array(); // 客服数组
var agentInfoArr = new Array();   // 用户数组

io.sockets.on('connection', ioConnection);

function ioConnection(socket) {
    console.log("进入 io.socket->connection 事件,有用户连接进来了!");

    /**
     * 客服登陆
     * 1,根据客服ID创建聊天室
     * @parameter 客服信息
     */
    socket.on('serviceLogin', function (data) {
        console.log("-------------------------------- 客服登陆 -----------------------------------");
        console.log("服务器:有客服登陆, id = " + data.serviceId + ", 昵称 = " + data.serviceNickName + ", 渠道 = " + data.channel);
        socket.join(data.serviceId);
        socket.room = data.serviceId;
        socket.serviceId = data.serviceId;
        socket.serviceNickName = data.serviceNickName;
        socket.channel = data.channel;
        console.log("创建客服会话,并存客服信息完成");
        serviceUserArr.push(socket);
        console.log("更新客服队列完成--等待用户连接...");
        var agentInfo = {resCode:0, serviceId : data.serviceId, serviceNickName : data.serviceNickName}
        socket.emit('serviceLoginResult', agentInfo);

        ////test
        //var s = serviceUserArr[0];
        //console.log("取出客服 socket.id = " + s.id);
    });

    /**
     * 分配客服方法
     * 1,判断当前在线的客服繁忙程度,分配会话
     * @returns 分配客服的socket实例
     */
    function assignService() {
        console.log("--------- 分配客服方法 ---------");
        //TODO 判断每次客服的繁忙程度 分配客服
        var serviceSocket;
        if (serviceUserArr.length > 0) {
            for (var i = 0; i < serviceUserArr.length; i++) {
                serviceSocket = serviceUserArr[i];
            }
        } else {
            serviceSocket = false;
        }
        return serviceSocket;
    }

    /**
     * 获取当前会话的Socket实例
     * @returns 当前会话的Socket实例
     */
    function getServiceSocket() {
        console.log("--------- 获取当前会话的Socket实例 ---------");
        //TODO 获取当前会话的socket（客服Socket）
        var serviceSocket;
        if (serviceUserArr.length > 0) {
            for (var i = 0; i < serviceUserArr.length; i++) {
                serviceSocket = serviceUserArr[i];
            }
        } else {
            serviceSocket = false;
        }
        return serviceSocket;
    }

    /**
     * 用户登陆
     * 1,分配客服(检查有没有可用客服[有,没有,繁忙],有则分配)
     * 2,加入对应的客服聊天室
     * 3,更新客服下的用户数组
     * @parameter 用户信息
     */
    socket.on('agentLogin', function (data) {
        console.log("-------------------------------- 用户登录 -----------------------------------");
        console.log('服务器:有用户登陆, 用户id = ' + data.agentId + " , 昵称 = " + data.agentNickName + " , 渠道 = " + data.channel);
        //执行分配用户逻辑
        var serviceSocket = assignService();
        if(!serviceSocket){
            console.log("当前没有客服在线");
            var loginResult = {resCode : 1, message : '当前没有客服在线'};
            socket.emit('agentLoginResult', loginResult);
            return;
        }
        //加入分配客服的聊天室
        socket.join(serviceSocket.serviceId);
        socket.room = serviceSocket.room;
        socket.agentId = data.agentId;
        socket.agentNickName = data.agentNickName;
        socket.channel = data.channel;
        console.log("用户 : " + data.agentId + " , 被分配到客服 " + serviceSocket.serviceNickName + " 的聊天室中");
        console.log("打印当前会话下用户数(包含一个客服) = " + io.sockets.adapter.rooms[serviceSocket.room].length);

        //更新客服下的用户数组
        console.log("客服:" + serviceSocket.serviceNickName + ",用户数组更新前 agentInfoArr = " + agentInfoArr.length);
        //TODO 找到当前客服下的用户数组 agentInfoArr
        agentInfoArr.push(socket);
        console.log("客服:" + serviceSocket.serviceNickName + ",用户数组更新后 agentInfoArr = " + agentInfoArr.length);

        //返回用户登陆结果
        console.log("当前客服serviceSocket.serviceId = " + serviceSocket.serviceId);
        console.log("当前客服serviceSocket.serviceNickName = " + serviceSocket.serviceNickName);
        var serviceInfo = {resCode : 0, serviceId : serviceSocket.serviceId, serviceNickName : serviceSocket.serviceNickName}
        socket.emit('agentLoginResult', serviceInfo);
        //给用户所在客服发送添加用户消息
        serviceSocket.emit('assignUser', data);
    });

    /**
     * 根据用户Id获取用户实例
     * @param agentInfoArr 当前房间的用户列表
     * @param agentId      检索条件:用户Id
     * @returns {*} 指定Id的用户Socket实例
     */
    function getAgentSocket(agentInfoArr, agentId) {
        console.log("--------- 根据用户Id获取用户实例 ---------");
        var agentSocket;
        if (agentInfoArr.length > 0) {
            console.log("agentInfoArr.length = " + agentInfoArr.length);
            for (var i = 0; i < agentInfoArr.length; i++) {
                console.log("匹配agentId = " + agentId + ", 匹配项 = " + agentInfoArr[i].agentId);
                if(agentId == agentInfoArr[i].agentId){
                    console.log("找到agentId实例");
                    agentSocket = agentInfoArr[i];
                } else {
                    console.log("未找到agentId实例");
                }
            }
            console.log("agentSocket.agentId = " + agentSocket.agentId);
            console.log("agentSocket.agentNickName = " + agentSocket.agentNickName);
        } else {
            agentSocket = false;
        }
        return agentSocket;
    }

    //收到客服端的默认回复
    socket.on('defRespondToAgent', function (data) {
        console.log("-------------------------------- 收到客服端的默认回复 -----------------------------------");
        console.log('收到客服端的默认回复, from = ' + data.from + " , to = " + data.to + " , 消息 = " + data.message);
        //找到这个用户的socket,并转发给这个用户
        var agentSocket = getAgentSocket(agentInfoArr, data.to);
        agentSocket.emit('defRespondToAgent', data);
    });

    /**
     * 服务器收到用户消息,转发给客服
     */
    socket.on('agentToServiceMsg', function (data) {
        console.log("---------------------------- 服务器收到用户消息,转发给客服 -------------------------------");
        console.log('服务器收到用户发给客服的消息 data.from = ' + data.from + " , data.to = " + data.to + " , data.message = " + data.message);
        //将消息转发给客服端
        //TODO 根据to客服的id获取到客服Socket实例
        var serviceSocket = getServiceSocket();
        console.log("serviceSocket.serviceId = " + serviceSocket.serviceId);
        serviceSocket.emit('agentToServiceMsg', data);
    });

    /**
     * 服务器收到客服消息,转发给用户
     */
    socket.on('serviceToAgentMsg', function (data) {
        console.log("---------------------------- 服务器收到客服消息,转发给用户 -------------------------------");
        console.log('服务器收到客服发给用户的消息 data.from = ' + data.from + " , data.to = " + data.to + " , data.message = " + data.message);
        //将消息转发给用户端
        var agentSocket = getAgentSocket(agentInfoArr, data.to);
        //判断用户还在不在
        if(!agentSocket){
            console.log('用户已经离开');
            var error = {resCode : 1, message: '未找到该用户!'};
            //发送给客服，用户还在不在
            socket.emit('error', data);
        }
        agentSocket.emit('serviceToAgentMsg', data);
        //获得当前房间内的所有客户端(人)
        //console.log("-----打印当前socket.room = " + socket.room);
        //var clients = io.sockets.adapter.rooms[socket.room].length;
        //console.log("打印client对象 = " + clients);//JSON.stringify(clients)
        ////遍历找到该用户
        //clients.forEach(function(client){
        //  console.log("client in " + socket.room + " ==== " + client);
        //  if(client.username == data.to){
        //    //指定用户发消息 - 服务端接收来自用户端的消息 - 转发给客服
        //      client.emit('serviceReciver', data);
        //  }
        //});
    });

    /**
     * 用户登出
     * 1,用户退出,输出信息
     * @parameter 用户信息
     */
    socket.on('agentLogout', function (data) {
        console.log("---------------------------- 用户登出 -------------------------------");
        console.log('有客户退出 agentId = ' + data.agentId + ", agentNickName = " + socket.agentNickName);
        //处理退出
        getAgentSocket(agentInfoArr, data.agentId).leave(getServiceSocket().room);
        //转发给客服端
        getServiceSocket().emit('agentLogout', data);
    });

}

/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
    var port = parseInt(val, 10);

    if (isNaN(port)) {
        // named pipe
        return val;
    }

    if (port >= 0) {
        // port number
        return port;
    }

    return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
    if (error.syscall !== 'listen') {
        throw error;
    }

    var bind = typeof port === 'string'
        ? 'Pipe ' + port
        : 'Port ' + port;

    // handle specific listen errors with friendly messages
    switch (error.code) {
        case 'EACCES':
            console.error(bind + ' requires elevated privileges');
            process.exit(1);
            break;
        case 'EADDRINUSE':
            console.error(bind + ' is already in use');
            process.exit(1);
            break;
        default:
            throw error;
    }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
    var addr = server.address();
    var bind = typeof addr === 'string'
        ? 'pipe ' + addr
        : 'port ' + addr.port;
    debug('Listening on ' + bind);
}





